pipeline {
    agent any
    environment {
        EXPO_TOKEN = 'ygWB9ZV5xO0_3bj5DdXGoBV6EJPaD_Ve26yyl_-D'  // Expo에서 생성한 토큰으로 대체하세요.
    }
    stages {
        stage('Start first pipeline') {
            steps {
                 writeFile file: 'art.txt', text: '''
     _______.___________.    ___      .______     .___________.    __       _______.___________.   .______    __  .______    _______  __       __  .__   __.  _______ 
    /       |           |   /   \\     |   _  \\    |           |   /_ |     /       |           |   |   _  \\  |  | |   _  \\  |   ____||  |     |  | |  \\ |  | |   ____|
   |   (----`---|  |----`  /  ^  \\    |  |_)  |   `---|  |----`    | |    |   (----`---|  |----`   |  |_)  | |  | |  |_)  | |  |__   |  |     |  | |   \\|  | |  |__   
    \\   \\       |  |      /  /_\\  \\   |      /        |  |         | |     \\   \\       |  |        |   ___/  |  | |   ___/  |   __|  |  |     |  | |  . `  | |   __|  
.----)   |      |  |     /  _____  \\  |  |\\  \\----.   |  |         | | .----)   |      |  |        |  |      |  | |  |      |  |____ |  `----.|  | |  |\\   | |  |____ 
|_______/       |__|    /__/     \\__\\ | _| `._____|   |__|         |_| |_______/       |__|        | _|      |__| | _|      |_______||_______||__| |__| \\__| |_______|
                    '''
                    bat "type art.txt"
                
            }
        }
        stage('Cleanup Workspace') {
            steps {
                deleteDir() // 워크스페이스를 정리합니다.
            }
        }
        stage('Clone Repository') {
            steps {
                  
                    echo '------------------------------Start to clone source code repository------------------------------'
                 
                checkout scmGit(branches: [[name: '*/test']], extensions: [], userRemoteConfigs: [[credentialsId: 'ef3df39a-ffb3-49cd-b5ba-3cf45fded93f', url: 'https://ai-powered-ui-test-admin@bitbucket.org/capstone-visual-testing-automation/aora-source-code.git']])
             
            }
        }
       
        stage('install npm ') {
            steps {
               dir('C:/ProgramData/Jenkins/.jenkins/workspace/aora-pipeline') {
                        bat "npm install"
                }
            }
        }
        stage('Build APK') {
            steps {
                script {
                  
                    echo '------------------------------Start to build new apk------------------------------'
                  
                    dir('C:/ProgramData/Jenkins/.jenkins/workspace/aora-pipeline') {
                        // EXPO_TOKEN을 사용하여 eas build 실행
                        bat "C:\\Users\\hhb72\\AppData\\Roaming\\npm\\eas build --platform android --profile production --json --non-interactive > pipeline/build_result.txt"
                    }
                 

                }
            }
        }
         stage('install pipeline npm') {
            steps {
                script {
                    dir('C:/ProgramData/Jenkins/.jenkins/workspace/aora-pipeline/pipeline') {
                        bat "npm install"
                    }
                }
            }
        }
        stage('Download APK') {
            steps {
                script {
                
                    echo '------------------------------Start to download new apk------------------------------'
               
                    dir('C:/ProgramData/Jenkins/.jenkins/workspace/aora-pipeline/pipeline') {
                        bat "npm install axios"
                        bat "node apkDownload.js"
                    }
                 
                }
            }
        }
         stage('Clone Target Repository') {
            steps {
                dir('target-repo') {
                    script {
                        bat """
                        REM Remove the existing directory if it exists
                        if exist aora-visual-testing rmdir /S /Q aora-visual-testing
                        REM Clone the repository
                        git clone -b master https://ai-powered-ui-test-admin@bitbucket.org/capstone-visual-testing-automation/aora-visual-testing.git
                        """
                    }
                }
            }
        }
        stage('Update APK in Resources') {
            steps {
                echo '------------------------------Start to update new apk to test code repository------------------------------'
                dir('target-repo/aora-visual-testing/Resources') {
                    script {    
                        bat """
                        REM Remove existing APK files
                        del /Q *.apk
                        REM Copy new APK file
                        copy C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\aora-pipeline\\pipeline\\*.apk .
                        """
                    }
                }
                
            }
        }
        
        
        stage('Commit and Push') {
            steps {
                dir('target-repo/aora-visual-testing') {
                    script {
                        withCredentials([usernamePassword(credentialsId: 'ef3df39a-ffb3-49cd-b5ba-3cf45fded93f', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                            bat """
                            git config user.name "jjheon0614"
                            git config user.email "gjgusqls123@gmail.com"
                            git add Resources\\*.apk
                            git commit -m "Update APK file"
                            git push https://${GIT_USERNAME}:${GIT_PASSWORD}@bitbucket.org/capstone-visual-testing-automation/aora-visual-testing.git master
                            """
                        }
                    }
                }
            }
        }

        stage('Success') {
            steps {
                 writeFile file: 'art.txt', text: '''
     _______. __    __    ______   ______  _______     _______.     _______. __   __  
    /       ||  |  |  |  /      | /      ||   ____|   /       |    /       ||  | |  | 
   |   (----`|  |  |  | |  ,----'|  ,----'|  |__     |   (----`   |   (----`|  | |  | 
    \\   \\    |  |  |  | |  |     |  |     |   __|     \\   \\        \\   \\    |  | |  | 
.----)   |   |  `--'  | |  `----.|  `----.|  |____.----)   |   .----)   |   |__| |__| 
|_______/     \\______/   \\______| \\______||_______|_______/    |_______/    (__) (__) 
                    '''
                    
                    bat "type art.txt"
            }
        }
    }
}
